<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ashna's Love Letter</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            touch-action: none;
            user-select: none;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 4px solid #fff;
            border-radius: 8px;
            overflow: hidden;
            width: 800px;
            max-width: 100%;
            aspect-ratio: 16/9;
            background: #000;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: #333;
        }

        /* OVERLAYS */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            text-align: center;
            z-index: 20;
            display: none; /* Hidden by default */
        }

        /* NOTIFICATION SCREEN - Reverted Style */
        #notification-screen {
            background: #111; 
            display: flex;
            z-index: 60;
        }
        
        .phone-notification {
            background: rgba(255, 255, 255, 0.95);
            color: #000;
            width: 90%; 
            max-width: 320px; /* Kept mobile friendly but original size feel */
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); /* Original dark shadow */
            cursor: pointer;
            text-align: left;
            animation: float 2s infinite ease-in-out;
            transition: transform 0.1s;
        }
        .phone-notification:active {
            transform: scale(0.95);
        }
        .notif-header {
            font-family: 'Nunito', sans-serif;
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .notif-body {
            font-family: 'Nunito', sans-serif;
        }
        .notif-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 2px;
        }
        .notif-preview {
            font-size: 14px;
            color: #333;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* COMIC VIEWER */
        #comic-screen {
            background: #000; 
            z-index: 100;
        }
        .comic-container {
            position: relative;
            width: 100%;
            height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
        }
        .comic-img {
            max-width: 100%;
            max-height: 100%;
            border: 4px solid #fff;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255,105,180, 0.5);
            object-fit: contain;
        }
        .comic-controls {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            width: 100%;
            justify-content: center;
            align-items: center;
        }
        .comic-btn {
            background: #FF69B4;
            color: white;
            border: 2px solid white;
            padding: 15px 25px;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            min-width: 120px;
            transition: transform 0.1s;
        }
        .comic-btn:active { transform: scale(0.95); }
        .comic-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
            border-color: #777;
        }
        .comic-counter {
            font-family: 'Press Start 2P';
            font-size: 12px;
            color: #aaa;
            margin-top: 10px;
        }

        /* LOADING SCREEN */
        #loading-screen {
            display: flex;
            z-index: 100;
            background: #000;
        }
        .loader-bar {
            width: 200px;
            height: 20px;
            border: 2px solid #FF69B4;
            margin-top: 20px;
            position: relative;
        }
        .loader-fill {
            height: 100%;
            background: #FF69B4;
            width: 0%;
            transition: width 0.2s;
        }

        /* CHAT INTRO SCREEN */
        #intro-chat {
            background: #f0f2f5; 
            font-family: 'Nunito', sans-serif;
            flex-direction: column;
            justify-content: flex-start;
            padding: 20px;
            box-sizing: border-box;
            z-index: 50;
            display: none;
            overflow-y: auto;
        }
        
        .chat-header {
            width: 100%;
            padding: 10px;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #333;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .chat-pfp {
            width: 40px; height: 40px;
            background: #ccc;
            border-radius: 50%;
            background-image: url('https://i.ibb.co/XfH2W7fs/sarup-bg.png');
            background-size: cover;
        }

        .chat-bubble {
            background: #fff;
            color: #333;
            padding: 12px 18px;
            border-radius: 20px;
            margin: 8px 0;
            max-width: 80%;
            align-self: flex-start;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(20px);
            animation: popIn 0.5s forwards;
            font-size: 16px;
            line-height: 1.5;
        }
        .chat-bubble.them {
            background: #e4e6eb;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        @keyframes popIn {
            to { opacity: 1; transform: translateY(0); }
        }

        .call-btn {
            background: #00C853;
            color: white;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            border: none;
            margin-top: 30px;
            cursor: pointer;
            animation: pulse 1s infinite;
            display: none; 
            font-weight: bold;
            box-shadow: 0 4px #009624;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* GAME UI */
        #start-screen { z-index: 15; }

        h1 {
            font-size: clamp(16px, 4vw, 24px);
            color: #FF69B4;
            text-shadow: 2px 2px #000;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        p {
            font-size: clamp(10px, 2vw, 12px);
            margin-bottom: 30px;
            line-height: 1.8;
            color: #eee;
            padding: 0 40px;
            max-width: 600px;
        }

        .btn {
            background: #FF69B4;
            color: white;
            border: 2px solid #fff;
            padding: 15px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            transition: transform 0.1s;
            text-transform: uppercase;
            box-shadow: 0 4px #C71585;
            margin-top: 20px;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 #C71585; }

        /* Battle UI */
        #battle-ui {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px;
            background: linear-gradient(#f8f8f8, #e0e0e0);
            border-top: 4px solid #333;
            display: none;
            padding: 10px;
            box-sizing: border-box;
            color: black;
            font-size: 12px;
            justify-content: space-between;
            z-index: 5;
        }
        .battle-text {
            width: 60%;
            background: #fff;
            border: 2px solid #333;
            border-radius: 5px;
            padding: 10px;
            line-height: 1.6;
            display: flex;
            align-items: center;
        }
        .battle-menu {
            width: 35%;
            background: #fff;
            border: 2px solid #333;
            border-radius: 5px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            padding: 5px;
        }
        .battle-btn {
            background: #f0f0f0;
            border: 1px solid #ccc;
            cursor: pointer;
            font-family: 'Press Start 2P';
            font-size: 8px;
            text-transform: uppercase;
        }
        .battle-btn:hover { background: #FF69B4; color: white; }
        .battle-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Controls */
        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: none;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 20px;
            box-sizing: border-box;
            pointer-events: none;
            z-index: 20;
        }
        .control-group { display: flex; gap: 15px; pointer-events: auto; }
        .control-btn {
            width: 55px; height: 55px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; color: white;
            pointer-events: auto; user-select: none;
            backdrop-filter: blur(2px);
        }
        .control-btn.shoot {
            background: rgba(255, 105, 180, 0.4);
            border-color: #FF69B4;
            font-size: 24px;
        }
        .control-btn:active { background: rgba(255, 255, 255, 0.5); }

        #message-box {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            text-align: center;
            font-size: clamp(10px, 2.5vw, 14px);
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
            z-index: 5;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #fff;
            display: none;
        }
        
        #volume-btn {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.5); color: white;
            border: 1px solid white; padding: 8px;
            font-size: 10px; cursor: pointer; z-index: 20;
            font-family: 'Press Start 2P';
        }

        #permit-popup {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 250px;
            background: white;
            border: 4px solid gold;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 30;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        #permit-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }
        .permit-icon {
            font-size: 60px;
            margin-bottom: 10px;
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .permit-text {
            font-family: 'Press Start 2P';
            font-size: 14px;
            color: black;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        .permit-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            font-family: 'Press Start 2P';
            font-size: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas" width="800" height="450"></canvas>
        <button id="volume-btn" onclick="toggleMute()">üîä ON</button>
        
        <div id="message-box"></div>

        <!-- Notification Screen -->
        <div id="notification-screen" class="overlay">
            <div class="phone-notification" onclick="openMessages()">
                <div class="notif-header">
                    <span>üí¨ WhatsApp</span>
                    <span>now</span>
                </div>
                <div class="notif-body">
                    <div class="notif-title">Sarup ‚ù§Ô∏è</div>
                    <div class="notif-preview">I've been thinking about you... üôà</div>
                </div>
            </div>
        </div>

        <!-- Chat Intro -->
        <div id="intro-chat" class="overlay">
            <div class="chat-header">
                <div class="chat-pfp"></div>
                <div>Sarup ‚ù§Ô∏è<br><span style="font-size:10px; color:#888; font-weight:normal;">Online</span></div>
            </div>
            <div id="chat-messages" style="display:flex; flex-direction:column; width:100%;"></div>
            <button class="call-btn" onclick="endChat()">üìû Accept Video Call</button>
        </div>

        <div id="permit-popup">
            <div class="permit-icon">üé´</div>
            <div class="permit-text">GATE PASS<br>ACQUIRED!</div>
            <button class="permit-btn" onclick="closePermit()">RUN TO CITY!</button>
        </div>

        <div id="start-screen" class="overlay">
            <h1 style="color: #FFB6C1">Ashna's Journey</h1>
            <p>
                <b>Mission:</b><br>
                1. Escape the Hostel (Defeat Warden)<br>
                2. Dodge Taxis in Kolkata<br>
                3. Fly to Sikkim<br>
                4. Find Sarup!<br><br>
                <b>Controls:</b> Arrows to Move<br>SPACE to Shoot Yarn üß∂
            </p>
            <button class="btn" onclick="startGame()">Start Game ‚ù§Ô∏è</button>
        </div>

        <div id="game-over-screen" class="overlay">
            <h1 style="color: #FF4444;" id="death-msg">Oh no!</h1>
            <p>Don't give up! Sarup is waiting.</p>
            <button class="btn" onclick="resetGame()">Try Again üòù</button>
        </div>

        <!-- Comic Viewer -->
        <div id="comic-screen" class="overlay">
            <div class="comic-container">
                <img id="comic-display" class="comic-img" src="" alt="Comic Page">
            </div>
            <div class="comic-counter" id="comic-counter">1 / 10</div>
            <div class="comic-controls">
                <button class="comic-btn" id="btn-prev" onclick="prevSlide()">PREV</button>
                <button class="comic-btn" id="btn-next" onclick="nextSlide()">NEXT</button>
            </div>
        </div>

        <!-- Battle UI -->
        <div id="battle-ui">
            <div class="battle-text" id="battle-log">
                Warden wants to fight!
            </div>
            <div class="battle-menu">
                <button class="battle-btn" onclick="playerAttack('web')">Yarn Web</button>
                <button class="battle-btn" onclick="playerAttack('call')">Video Call</button>
                <button class="battle-btn" onclick="playerAttack('pout')">Cute Pout</button>
                <button class="battle-btn" onclick="playerAttack('stare')">Stare</button>
            </div>
        </div>

        <div id="controls">
            <div class="control-group">
                <div class="control-btn" id="btn-left">‚Üê</div>
                <div class="control-btn" id="btn-right">‚Üí</div>
            </div>
            <div class="control-group">
                <div class="control-btn shoot" id="btn-shoot">üß∂</div>
                <div class="control-btn" id="btn-jump">‚Üë</div>
            </div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const msgBox = document.getElementById('message-box');
    const battleUI = document.getElementById('battle-ui');
    const battleLog = document.getElementById('battle-log');
    const controlsUI = document.getElementById('controls');
    const permitPopup = document.getElementById('permit-popup');
    const notifScreen = document.getElementById('notification-screen');
    const introChat = document.getElementById('intro-chat');
    const chatMsgs = document.getElementById('chat-messages');
    const startScreen = document.getElementById('start-screen');
    const comicScreen = document.getElementById('comic-screen');
    const comicDisplay = document.getElementById('comic-display');
    const comicCounter = document.getElementById('comic-counter');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');

    // --- Audio System ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    let isMuted = false;

    function toggleMute() {
        isMuted = !isMuted;
        document.getElementById('volume-btn').innerText = isMuted ? "üîá OFF" : "üîä ON";
    }

    const playSound = (type) => {
        if (isMuted) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);

        if (type === 'jump') {
            osc.type = 'square'; osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(300, now+0.1);
            gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
            osc.start(now); osc.stop(now+0.1);
        } else if (type === 'web') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(600, now);
            osc.frequency.exponentialRampToValueAtTime(100, now+0.2);
            gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now+0.2);
            osc.start(now); osc.stop(now+0.2);
        } else if (type === 'battle_hit') {
            osc.type = 'square'; osc.frequency.setValueAtTime(100, now);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.15);
            osc.start(now); osc.stop(now+0.15);
        } else if (type === 'item') {
             osc.type = 'sine'; osc.frequency.setValueAtTime(600, now);
             osc.frequency.linearRampToValueAtTime(1200, now+0.2);
             gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
             osc.start(now); osc.stop(now+0.3);
        } else if (type === 'win') {
            [523, 659, 784, 1046].forEach((f,i) => {
                let o=audioCtx.createOscillator(); let g=audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.value=f; o.type='triangle';
                g.gain.setValueAtTime(0.05, now+i*0.1); g.gain.linearRampToValueAtTime(0, now+i*0.1+0.2);
                o.start(now+i*0.1); o.stop(now+i*0.1+0.2);
            });
        } else if (type === 'msg') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
            gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
            osc.start(now); osc.stop(now+0.1);
        }
    };

    // --- Asset Loading System ---
    const ts = new Date().getTime();
    const imagesToLoad = [
        { name: 'bg', src: 'https://i.ibb.co/zHQN0g8d/1.jpg?' + ts },
        { name: 'kol', src: 'https://i.ibb.co/zhyXYSMg/kol.png?' + ts },
        { name: 'sarup', src: 'https://i.ibb.co/XfH2W7fs/sarup-bg.png?' + ts },
        { name: 'ashna', src: 'https://i.ibb.co/2081mhnP/ashna-png.png?' + ts },
        { name: 'taxi', src: 'https://i.ibb.co/bgr1jRjB/taxi.png?' + ts },
        { name: 'plane', src: 'https://i.ibb.co/dwJ6c2X4/plane.png?' + ts }
    ];

    const assets = {};
    let loadedCount = 0;

    function loadAssets() {
        imagesToLoad.forEach(imgData => {
            const img = new Image();
            img.onload = () => { assets[imgData.name] = img; };
            img.src = imgData.src;
        });
    }

    // --- Chat Intro Logic ---
    const messages = [
        "Hey beautiful... ‚ù§Ô∏è",
        "I've been thinking about you all night, imagining your naked body pressed against mine.",
        "You have no idea how much I want you right now, how I crave to dominate every part of you.",
        "I want to tie you down with silk ropes, so you can't move while I explore you completely.",
        "...making sure you're helpless as I kiss and lick every inch of your skin, from your toes to your neck.",
        "But seriously, I want complete obedience tonight ‚Äì you'll do exactly as I command, my perfect submissive girl.",
        "When I say 'come here', you come, and drop to your knees ready for whatever I desire.",
        "I miss kissing your feet so much, worshipping them with my tongue, making you feel like my queen.",
        "I want to kiss and bite every inch of your body, leaving marks that show you're mine.",
        "God, I need to feel your pussy right now ‚Äì I want to slide my fingers deep inside you, feeling you get wetter and wetter.",
        "I'll curl them just right, hitting that spot that makes you moan my name uncontrollably.",
        "And then, I want you to sit on my face, grinding against my tongue as I taste you fully, controlling your pleasure.",
        "Feel my hands gripping your thighs, pulling you down harder while you ride my mouth.",
        "You turn me on so much with your dirty mind ‚Äì I love how you submit to me, letting me take charge.",
        "I want to touch every inch of you, pinching your nipples, spanking your ass until it's red and you're begging for more.",
        "Come here so I can ruin your lipstick with deep, passionate kisses, then flip you over and take you from behind.",
        "I'll thrust into you slowly at first, building up until you're screaming in ecstasy.",
        "And if you're naughty, I'll spank you harder, making you promise to obey me completely üëãüçë",
        "I want to feel you clench around me as I fill you up, owning your body in every way.",
        "But I also miss the tender moments, like holding you after, kissing your forehead while you catch your breath.",
        "You're my everything ‚Äì my lover, my submissive, my world.",
        "Okay, enough teasing for now, though I could go on forever about what I want to do to you.",
        "I built a whole world just for us, where we can explore all these fantasies without limits.",
        "Come find me? I'm waiting in the hills... üèîÔ∏è",
        "Can't wait to make all this real with you, my love."
    ];

    function openMessages() {
        notifScreen.style.display = 'none';
        introChat.style.display = 'flex';
        if (audioCtx.state === 'suspended') audioCtx.resume();
        startChatSequence();
    }

    function startChatSequence() {
        let delay = 0;
        messages.forEach((msg, i) => {
            const readingTime = msg.length * 30; 
            delay += readingTime + 600; 

            setTimeout(() => {
                const d = document.createElement('div');
                d.className = 'chat-bubble them';
                d.innerText = msg;
                chatMsgs.appendChild(d);
                playSound('msg');
                introChat.scrollTop = introChat.scrollHeight;
                
                if (i === messages.length - 1) {
                    setTimeout(() => {
                        document.querySelector('.call-btn').style.display = 'block';
                        introChat.scrollTop = introChat.scrollHeight;
                    }, 1000);
                }
            }, delay);
        });
    }

    function endChat() {
        introChat.style.display = 'none';
        startScreen.style.display = 'flex';
    }

    // --- Comic Logic ---
    const comicImages = [
        "https://raw.githubusercontent.com/Sarup098/assna/main/1f.png",
        "https://raw.githubusercontent.com/Sarup098/assna/main/2f.png",
        "https://raw.githubusercontent.com/Sarup098/assna/main/3f.png",
        "https://raw.githubusercontent.com/Sarup098/assna/main/4f.png",
        "https://raw.githubusercontent.com/Sarup098/assna/main/5f.png",
        "https://raw.githubusercontent.com/Sarup098/assna/main/6f.png",
        "https://raw.githubusercontent.com/Sarup098/assna/main/7f.png",
        "https://raw.githubusercontent.com/Sarup098/assna/main/8f.png",
        "https://raw.githubusercontent.com/Sarup098/assna/main/9f.png",
        "https://raw.githubusercontent.com/Sarup098/assna/main/10f.png"
    ];
    let comicIdx = 0;

    function updateComic() {
        comicDisplay.src = comicImages[comicIdx];
        comicCounter.innerText = (comicIdx + 1) + " / " + comicImages.length;
        
        btnPrev.disabled = (comicIdx === 0);
        
        if (comicIdx === comicImages.length - 1) {
            btnNext.innerText = "FINISH ‚ù§Ô∏è";
        } else {
            btnNext.innerText = "NEXT";
        }
    }

    function nextSlide() {
        if (comicIdx < comicImages.length - 1) {
            comicIdx++;
            updateComic();
        } else {
            // Finish
            alert("I love you, Ashna! ‚ù§Ô∏è");
            location.reload(); // Restart game
        }
    }

    function prevSlide() {
        if (comicIdx > 0) {
            comicIdx--;
            updateComic();
        }
    }


    // --- Game Variables ---
    let gameState = 'START'; 
    let gameMode = 'PLATFORM'; 
    let cameraX = 0;
    let savedCheckpoint = 'HOSTEL';
    let hasPass = false; 
    let battleTimer = 0; 
    
    const GRAVITY = 0.5;
    const JUMP_FORCE = -9;
    const SPEED = 4;
    
    const player = { x: 50, y: 300, w: 60, h: 60, dx: 0, dy: 0, facingRight: true, hp: 100, grounded: false, color: '#FF69B4' };
    const goal = { x: 3800, y: 360, w: 24, h: 36 };

    let battleState = { phase: 'IDLE', wardenHp: 60, displayedWardenHp: 60, playerOffset: 0, wardenOffset: 0, shake: 0, flash: 0, projectile: { active: false, x:0, y:0, type:'none' }, logText: "" };

    let platforms = [], enemies = [], webs = [], particles = [], decor = [], tutorials = [];
    
    // --- Inputs (Mobile + Desktop) ---
    const keys = { left:false, right:false, up:false, space:false };
    
    // Force touch controls on for mobile responsiveness check
    const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    if(isTouch || window.innerWidth < 800) controlsUI.style.display='flex';
    
    // Desktop Keys
    window.addEventListener('keydown', e => { if(e.code==='ArrowRight') keys.right=true; if(e.code==='ArrowLeft') keys.left=true; if(e.code==='ArrowUp') handleJump(); if(e.code==='Space') fireWeb(); });
    window.addEventListener('keyup', e => { if(e.code==='ArrowRight') keys.right=false; if(e.code==='ArrowLeft') keys.left=false; if(e.code==='ArrowUp') keys.up=false; });
    
    // Mobile Touch
    const bindTouch = (id, fn) => { 
        const el = document.getElementById(id); 
        el.addEventListener('touchstart', (e)=>{e.preventDefault(); fn(true);}); 
        el.addEventListener('touchend', (e)=>{e.preventDefault(); fn(false);}); 
    };
    bindTouch('btn-left', (v)=>keys.left=v); 
    bindTouch('btn-right', (v)=>keys.right=v); 
    bindTouch('btn-jump', (v)=>{if(v) handleJump(); keys.up=v;}); 
    bindTouch('btn-shoot', (v)=>{if(v) fireWeb();});

    // --- Game Logic ---
    function handleJump() {
        if(gameState!=='PLAYING') return;
        if (gameMode === 'PLATFORM' && player.grounded && !keys.up) { player.dy = JUMP_FORCE; player.grounded = false; playSound('jump'); }
        else if (gameMode === 'FLYING' && !keys.up) { player.dy = -7; playSound('jump'); }
    }

    function fireWeb() {
        if(gameState!=='PLAYING' || gameMode === 'FLYING') return;
        webs.push({ startX: player.x+30, startY: player.y+30, endX: player.x+30, endY: player.y+30, dir: player.facingRight?1:-1, speed: 12, maxLen: 200, life: 20 });
        playSound('web');
    }

    function initLevel() {
        platforms=[]; enemies=[]; webs=[]; particles=[]; decor=[]; tutorials=[];
        cameraX = 0; player.x = 50; player.y = 300; player.dx=0; player.dy=0;
        gameMode = 'PLATFORM'; hasPass = false; msgBox.style.display = 'none'; battleUI.style.display = 'none'; permitPopup.classList.remove('show');
        
        // ZONE 1
        platforms.push({x:0, y:400, w:800, h:50, type:'wood'});
        decor.push({x:20, y:250, type:'flower'});
        platforms.push({x:200, y:350, w:100, h:10, type:'bed'});
        decor.push({x:220, y:340, type:'pillow'});
        enemies.push({x:600, y:350, w:40, h:50, type:'warden'});
        platforms.push({x:700, y:200, w:20, h:200, type:'gate', open:false});

        // ZONE 2
        platforms.push({x:800, y:400, w:1000, h:50, type:'road'});
        enemies.push({x:1000, y:340, w:110, h:60, type:'car', minX:900, maxX:1400, speed:3, dir:1});
        enemies.push({x:1400, y:340, w:110, h:60, type:'car', minX:1200, maxX:1700, speed:4, dir:-1});
        platforms.push({x:1750, y:350, w:100, h:50, type:'step'});

        // ZONE 3
        createCloudGate(2300); createCloudGate(2700);

        // ZONE 4
        platforms.push({x:3000, y:400, w:1000, h:50, type:'grass'});
        platforms.push({x:3200, y:350, w:80, h:50, type:'grass'});
        platforms.push({x:3350, y:300, w:80, h:100, type:'grass'});
        platforms.push({x:3500, y:250, w:80, h:150, type:'grass'});
        platforms.push({x:3700, y:360, w:300, h:40, type:'grass'});
        goal.x = 3850; goal.y = 360 - 36;
        
        tutorials.push({x:100, text:"Arrows to Move. SPACE to Shoot Yarn!", shown:false});
    }

    function createCloudGate(x) {
        const gapY = 150 + Math.random() * 150;
        enemies.push({x: x, y: -200, w: 60, h: gapY + 200, type: 'cloud_gate_top'});
        enemies.push({x: x, y: gapY + 140, w: 60, h: 500, type: 'cloud_gate_bottom'});
    }

    function update() {
        if(gameState === 'BATTLE') { updateBattle(); return; }
        if(gameState !== 'PLAYING') return;

        if (player.x > 800 && savedCheckpoint === 'HOSTEL') savedCheckpoint = 'CITY';
        if (player.x > 1850 && savedCheckpoint === 'CITY') savedCheckpoint = 'FLIGHT';

        if (player.x > 1850 && player.x < 3000) {
            if (gameMode !== 'FLYING') { gameMode = 'FLYING'; player.y = 200; player.dy = 0; }
        } else if (player.x >= 3000) gameMode = 'PLATFORM';

        tutorials.forEach(t => { if(!t.shown && player.x > t.x) { showMessage(t.text); t.shown = true; } });

        if (gameMode === 'PLATFORM') {
            if (keys.right) { player.dx = SPEED; player.facingRight=true; }
            else if (keys.left) { player.dx = -SPEED; player.facingRight=false; }
            else { player.dx = 0; }
            player.dy += GRAVITY; player.grounded = false;
        } else {
            player.dx = SPEED + 1; player.dy += GRAVITY * 0.5;
        }

        player.x += player.dx; player.y += player.dy;
        if (player.y > canvas.height + 50) die("You fell!");

        platforms.forEach(p => {
            if(p.type==='gate' && p.open) return;
            if (gameMode==='PLATFORM' && checkRect(player, p)) {
                if (player.dy > 0 && player.y + player.h - player.dy <= p.y + 10) { player.grounded = true; player.dy = 0; player.y = p.y - player.h; }
                else if (p.type==='wall' || (p.type==='gate' && !p.open)) { if(player.dx>0) player.x=p.x-player.w; else player.x=p.x+p.w; }
            }
        });

        enemies.forEach(e => {
            if (e.type === 'car' && !e.frozen) { e.x += e.speed * e.dir; if (e.x > e.maxX || e.x < e.minX) e.dir *= -1; }
            if (checkRect(player, e)) {
                if (e.type === 'warden') startBattle();
                else if (!e.frozen) die(e.type==='car'?"Traffic accident!":"Hit a cloud!");
            }
        });

        for (let i = webs.length-1; i>=0; i--) {
            let w = webs[i]; w.endX += w.speed * w.dir; w.life--;
            enemies.forEach(e => {
                if (e.type === 'car' && checkRect({x:w.endX, y:w.endY, w:5, h:5}, e)) {
                    e.frozen = true; w.life = 0; createParticles(e.x, e.y, 'sunflower');
                }
            });
            if (Math.abs(w.endX - w.startX) > w.maxLen || w.life <= 0) webs.splice(i,1);
        }

        if (checkRect(player, goal)) winGame();
        let targetX = player.x - 200; if(targetX < 0) targetX = 0; cameraX += (targetX - cameraX) * 0.1;
        updateParticles();
    }

    function startBattle() {
        if(gameState === 'BATTLE') return;
        gameState = 'BATTLE'; battleUI.style.display = 'flex'; controlsUI.style.display = 'none';
        battleState = { phase: 'IDLE', wardenHp: 60, displayedWardenHp: 60, playerOffset: 0, wardenOffset: 0, shake: 0, flash: 0, projectile: {active:false, x:0, y:0, type:'none'} };
        battleLog.innerText = "Warden blocks the way!";
    }

    function playerAttack(move) {
        if (battleState.phase !== 'IDLE') return;
        let dmg = 0, pType = 'web', txt = "";
        if(move === 'web') { dmg = 35; pType='web'; txt="Ashna shot Yarn!"; }
        else if(move === 'call') { dmg = 30; pType='heart'; txt="Ashna called Sarup!"; }
        else if(move === 'pout') { dmg = 20; pType='heart'; txt="Super effective pout!"; }
        else { dmg = 10; pType='none'; txt="Awkward stare..."; }
        battleState.phase = 'PLAYER_ATTACK'; battleState.logText = "Ashna used " + move.toUpperCase(); battleLog.innerText = battleState.logText;
        battleTimer = 0; battleState.dmg = dmg; battleState.pType = pType; battleState.hitTxt = txt;
    }

    function updateBattle() {
        battleTimer++;
        if(battleState.displayedWardenHp > battleState.wardenHp) battleState.displayedWardenHp -= 1;
        if(battleState.shake > 0) battleState.shake *= 0.85;

        switch(battleState.phase) {
            case 'PLAYER_ATTACK':
                if(battleTimer<10) battleState.playerOffset+=3; else if(battleTimer<20) battleState.playerOffset-=3;
                else { if(battleState.pType!=='none') { battleState.phase='PROJECTILE'; battleState.projectile={active:true, x:200, y:300, type:battleState.pType, targetX:600, targetY:150}; } else battleState.phase='HIT'; battleTimer=0; }
                break;
            case 'PROJECTILE':
                let p = battleState.projectile; let dx=p.targetX-p.x, dy=p.targetY-p.y, dist=Math.sqrt(dx*dx+dy*dy);
                if(dist<20) { p.active=false; battleState.phase='HIT'; battleTimer=0; } else { p.x+=dx/dist*15; p.y+=dy/dist*15; }
                break;
            case 'HIT':
                if(battleTimer===1) { battleState.wardenHp-=battleState.dmg; if(battleState.wardenHp<0) battleState.wardenHp=0; battleState.shake=15; battleState.flash=10; playSound('battle_hit'); battleLog.innerText=battleState.hitTxt; }
                if(battleTimer>60) { if(battleState.wardenHp<=0) { battleState.phase='WIN'; battleTimer=0; } else { battleState.phase='ENEMY_TURN'; battleTimer=0; } }
                break;
            case 'ENEMY_TURN':
                if(battleTimer===1) battleLog.innerText="Warden used Curfew!";
                if(battleTimer===30) { battleState.wardenOffset=-20; playSound('battle_hit'); battleState.shake=5; }
                if(battleTimer>30 && battleState.wardenOffset<0) battleState.wardenOffset+=2;
                if(battleTimer===80) battleLog.innerText="But Ashna ignored it!";
                if(battleTimer>120) { battleState.phase='IDLE'; battleLog.innerText="What will Ashna do?"; }
                break;
            case 'WIN':
                battleUI.style.display='none'; if(isTouch) controlsUI.style.display='flex';
                let wIdx = enemies.findIndex(e=>e.type==='warden'); if(wIdx>-1) enemies.splice(wIdx,1);
                let gate = platforms.find(p=>p.type==='gate'); if(gate) gate.open=true;
                playSound('item'); permitPopup.classList.add('show'); gameState='PAUSED';
                break;
        }
    }

    function closePermit() { permitPopup.classList.remove('show'); gameState='PLAYING'; hasPass=true; showMessage("Gate Opened! Run to the City!"); }

    function draw() {
        ctx.save();
        let bg = ctx.createLinearGradient(0,0,0,canvas.height);
        if(player.x < 800) { bg.addColorStop(0,'#FFEFD5'); bg.addColorStop(1,'#FFC0CB'); }
        else if(player.x < 1800) { bg.addColorStop(0,'#87CEEB'); bg.addColorStop(1,'#f0f0f0'); }
        else if(player.x < 3000) { bg.addColorStop(0,'#00BFFF'); bg.addColorStop(1,'#FFFFFF'); }
        else { bg.addColorStop(0,'#E0FFFF'); bg.addColorStop(1,'#87CEEB'); }
        ctx.fillStyle = bg; ctx.fillRect(0,0,canvas.width, canvas.height);
        
        ctx.filter = 'blur(3px) brightness(1.2)';
        let blendFactor = 0;
        if(player.x > 1800 && player.x < 3000) { blendFactor = (player.x - 1800) / 1200; if(blendFactor<0) blendFactor=0; if(blendFactor>1) blendFactor=1; }
        else if(player.x >= 3000) blendFactor = 1;

        if(blendFactor < 1) { ctx.globalAlpha = 1-blendFactor; if(player.x >= 800 || hasPass) drawKolkataBg(ctx, cameraX); }
        if(blendFactor > 0) { ctx.globalAlpha = blendFactor; drawSikkimBg(ctx, cameraX); }
        
        ctx.globalAlpha = 1; ctx.filter = 'none';
        ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.restore();

        if(player.x < 800 && !hasPass) drawHostelBg(ctx, cameraX);

        if(gameState === 'BATTLE') {
            ctx.save();
            let sx = (Math.random()-0.5)*battleState.shake, sy = (Math.random()-0.5)*battleState.shake; ctx.translate(sx, sy);
            ctx.fillStyle = '#2c3e50'; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.beginPath(); ctx.arc(200, 300, 100, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(600, 150, 80, 0, Math.PI*2); ctx.fill();
            if(assets.ashna) ctx.drawImage(assets.ashna, 150+battleState.playerOffset, 190, 120, 120); else { ctx.fillStyle=player.color; ctx.fillRect(150+battleState.playerOffset, 250, 100, 100); }
            if(battleState.projectile.active) {
                let p = battleState.projectile;
                if(p.type==='web') { ctx.fillStyle='#FFD700'; ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle='#FFD700'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(150, 300); ctx.lineTo(p.x, p.y); ctx.stroke(); }
                else { ctx.fillStyle='pink'; ctx.beginPath(); ctx.arc(p.x, p.y, 10, 0, Math.PI*2); ctx.fill(); }
            }
            if(battleState.flash>0) { ctx.fillStyle='red'; battleState.flash--; } else ctx.fillStyle='#000';
            let wx=560+battleState.wardenOffset; ctx.fillRect(wx, 100, 80, 100);
            if(battleState.flash<=0) { ctx.fillStyle='#F0C0A0'; ctx.fillRect(wx+20, 80, 40, 30); ctx.fillStyle='white'; ctx.font="20px Arial"; ctx.fillText("üò†", wx+30, 100); }
            drawHpBar(500, 50, battleState.displayedWardenHp, 60, "Warden"); drawHpBar(100, 200, 100, 100, "Ashna");
            ctx.restore(); requestAnimationFrame(loop); return;
        }

        ctx.save(); ctx.translate(-cameraX, 0);
        decor.forEach(d => { if(d.type==='flower') drawFlower(d.x, d.y, 5); if(d.type==='pillow') { ctx.fillStyle='pink'; ctx.fillRect(d.x, d.y, 20, 10); } });
        platforms.forEach(p => {
            if(p.type==='gate' && p.open) return;
            if(p.type==='wood') ctx.fillStyle='#8B4513'; else if(p.type==='road') ctx.fillStyle='#444'; else if(p.type==='grass') ctx.fillStyle='#228B22'; else ctx.fillStyle='#333';
            ctx.fillRect(p.x, p.y, p.w, p.h);
            if(p.type==='road') { ctx.fillStyle='white'; for(let i=0; i<p.w; i+=40) ctx.fillRect(p.x+i, p.y+20, 20, 2); }
        });
        enemies.forEach(e => {
            if(e.type==='car') {
                if(e.frozen) drawSunflower(e.x+20, e.y+10, 15);
                else if(assets.taxi) { ctx.save(); if(e.dir>0){ctx.translate(e.x+e.w,e.y); ctx.scale(-1,1); ctx.drawImage(assets.taxi,0,0,e.w,e.h);} else ctx.drawImage(assets.taxi,e.x,e.y,e.w,e.h); ctx.restore(); }
                else { ctx.fillStyle='#FFD700'; ctx.fillRect(e.x,e.y,e.w,e.h); }
            } else if(e.type==='warden') {
                ctx.fillStyle='#000'; ctx.fillRect(e.x,e.y,e.w,e.h); ctx.fillStyle='#FFD700'; ctx.fillRect(e.x+5,e.y+10,5,5);
                ctx.fillStyle='white'; ctx.fillRect(e.x+5,e.y+5,10,5); ctx.fillStyle='red'; ctx.fillRect(e.x+8,e.y+7,2,2);
            } else if(e.type.includes('cloud')) {
                ctx.fillStyle='rgba(255,255,255,0.9)'; let r=25; for(let cy=e.y; cy<e.y+e.h; cy+=30) { ctx.beginPath(); ctx.arc(e.x+e.w/2,cy,r,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(e.x+10,cy+10,r*0.8,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(e.x+e.w-10,cy+10,r*0.8,0,Math.PI*2); ctx.fill(); }
            }
        });
        ctx.strokeStyle='#FFD700'; ctx.lineWidth=3;
        webs.forEach(w => { ctx.beginPath(); ctx.moveTo(w.startX, w.startY); ctx.lineTo(w.endX, w.endY); ctx.stroke(); ctx.fillStyle='#FFD700'; ctx.beginPath(); ctx.arc(w.endX, w.endY, 4, 0, Math.PI*2); ctx.fill(); });

        if(gameMode==='PLATFORM') {
            if(assets.ashna) { ctx.save(); if(!player.facingRight) { ctx.translate(player.x+player.w,player.y); ctx.scale(-1,1); ctx.drawImage(assets.ashna,0,0,player.w,player.h); } else ctx.drawImage(assets.ashna,player.x,player.y,player.w,player.h); ctx.restore(); }
            else { ctx.fillStyle=player.color; ctx.fillRect(player.x,player.y,player.w,player.h); }
        } else {
            if(assets.plane) { ctx.drawImage(assets.plane, player.x, player.y, 100, 60); if(assets.ashna) ctx.drawImage(assets.ashna, player.x+45, player.y+10, 25, 25); }
            else { ctx.fillStyle='#FFF'; ctx.fillRect(player.x,player.y,60,30); }
        }

        if(assets.sarup) ctx.drawImage(assets.sarup, goal.x-10, goal.y-20, 50, 60); else { ctx.fillStyle='#4169E1'; ctx.fillRect(goal.x,goal.y,goal.w,goal.h); }
        ctx.fillStyle='#8B4513'; ctx.fillRect(goal.x+45, goal.y-10, 5, 46); ctx.fillStyle='#FFF'; ctx.fillRect(goal.x+40, goal.y-10, 20, 15);

        particles.forEach(p => {
            if(p.type==='sunflower') drawSunflower(p.x, p.y, p.r);
            else { ctx.fillStyle=p.c; ctx.globalAlpha=p.life/60; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill(); }
        });
        ctx.globalAlpha=1; ctx.restore(); requestAnimationFrame(loop);
    }

    function drawHostelBg(ctx, cameraX) {
        const wallX = cameraX * 0.5; ctx.save(); ctx.translate(-wallX, 0);
        ctx.fillStyle = '#FDF5E6'; ctx.fillRect(0, 0, 800, 450); 
        ctx.fillStyle = '#DB7093'; ctx.font = '20px "Press Start 2P"'; ctx.textAlign = 'center';
        ctx.fillText("AssNa's room", 400, 150); ctx.fillText("AU kolkata", 400, 180);
        ctx.strokeStyle = '#D8BFD8'; ctx.lineWidth = 5; ctx.strokeRect(250, 100, 300, 120);
        ctx.restore();
    }

    function drawSikkimBg(ctx, cameraX) {
        if(!assets.bg) return;
        const tileW = 800, tileH = 450, startX = 2500, numTiles = 5;
        for (let i = 0; i < numTiles; i++) {
            let xPos = startX + (i * tileW);
            if (xPos + tileW < cameraX || xPos > cameraX + 800) continue;
            if (i % 2 === 0) ctx.drawImage(assets.bg, xPos, 0, tileW, tileH);
            else { ctx.save(); ctx.translate(xPos + tileW, 0); ctx.scale(-1, 1); ctx.drawImage(assets.bg, 0, 0, tileW, tileH); ctx.restore(); }
        }
    }

    function drawKolkataBg(ctx, cameraX) {
        if(!assets.kol) return;
        const tileW = 800, tileH = 450, startX = -200, numTiles = 4;
        for (let i = 0; i < numTiles; i++) {
            let xPos = startX + (i * tileW);
            if (xPos + tileW < cameraX || xPos > cameraX + 800) continue;
            if (i % 2 === 0) ctx.drawImage(assets.kol, xPos, 0, tileW, tileH);
            else { ctx.save(); ctx.translate(xPos + tileW, 0); ctx.scale(-1, 1); ctx.drawImage(assets.kol, 0, 0, tileW, tileH); ctx.restore(); }
        }
    }

    function checkRect(r1, r2) { return (r1.x < r2.x + r2.w && r1.x + r1.w > r2.x && r1.y < r2.y + r2.h && r1.y + r1.h > r2.y); }
    function showMessage(text) { msgBox.innerText = text; msgBox.style.display = 'block'; setTimeout(() => msgBox.style.display='none', 3000); }
    function die(reason) { gameState = 'GAMEOVER'; document.getElementById('death-msg').innerText = reason; document.getElementById('game-over-screen').style.display = 'flex'; }
    function drawHpBar(x, y, hp, max, name) { ctx.fillStyle='white'; ctx.font="14px 'Press Start 2P'"; ctx.fillText(name, x, y); ctx.fillStyle='#333'; ctx.fillRect(x, y+10, 200, 15); let pct = hp/max; if(pct<0) pct=0; ctx.fillStyle = pct>0.5?'#0f0':pct>0.2?'#ff0':'#f00'; ctx.fillRect(x, y+10, 200*pct, 15); }
    function drawFlower(x, y, r) { ctx.fillStyle='pink'; ctx.beginPath(); ctx.arc(x,y-r,r,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x-r,y,r,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x+r,y,r,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x,y+r,r,0,Math.PI*2); ctx.fill(); ctx.fillStyle='yellow'; ctx.beginPath(); ctx.arc(x,y,r*0.6,0,Math.PI*2); ctx.fill(); }
    function drawSunflower(x, y, r) { ctx.fillStyle='#FFD700'; for(let i=0; i<8; i++) { let angle=(i/8)*Math.PI*2; ctx.beginPath(); ctx.arc(x+Math.cos(angle)*r, y+Math.sin(angle)*r, r*0.4, 0, Math.PI*2); ctx.fill(); } ctx.fillStyle='#8B4513'; ctx.beginPath(); ctx.arc(x,y,r*0.5,0,Math.PI*2); ctx.fill(); }
    function createParticles(x, y, type) { if (type === 'sunflower') { particles.push({x:x, y:y, type:'sunflower', life:120, r:15, c:null, vx:0, vy:0}); return; } for(let i=0; i<8; i++) particles.push({x:x, y:y, vx:(Math.random()-0.5)*4, vy:(Math.random()-0.5)*4, life:60, c:type==='flower'?'pink':'red', r:Math.random()*3}); }
    function updateParticles() { for(let i=particles.length-1; i>=0; i--) { let p=particles[i]; if(p.type!=='sunflower') { p.x+=p.vx; p.y+=p.vy; } p.life--; if(p.life<=0) particles.splice(i,1); } }
    function startGame() { if(audioCtx.state === 'suspended') audioCtx.resume(); document.getElementById('start-screen').style.display = 'none'; initLevel(); gameState = 'PLAYING'; loop(); }
    function resetGame() { document.getElementById('game-over-screen').style.display = 'none'; initLevel(); if (savedCheckpoint === 'CITY') { player.x = 820; player.y = 350; let gate = platforms.find(p=>p.type==='gate'); if(gate) gate.open = true; let wIndex = enemies.findIndex(e => e.type==='warden'); if(wIndex > -1) enemies.splice(wIndex, 1); } else if (savedCheckpoint === 'FLIGHT') { player.x = 1750; player.y = 300; gameMode = 'PLATFORM'; let gate = platforms.find(p=>p.type==='gate'); if(gate) gate.open = true; let wIndex = enemies.findIndex(e => e.type==='warden'); if(wIndex > -1) enemies.splice(wIndex, 1); } gameState = 'PLAYING'; }
    
    function winGame() { 
        if(gameState==='WIN') return; 
        gameState = 'WIN'; 
        player.dx=0; player.dy=0; 
        playSound('win'); 
        createParticles(goal.x, goal.y, 'heart'); 
        
        // Trigger comic view IMMEDIATELY (No delay)
        comicScreen.style.display = 'flex';
        updateComic();
    }
    
    function loop() { update(); draw(); }

    // Start Asset Loading
    window.onload = function() {
        notifScreen.style.display = 'flex'; // Ensure notification is visible first
        loadAssets(); // Background load
    };
</script>
</body>
</html>
